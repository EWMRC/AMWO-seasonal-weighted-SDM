---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
library(raster)
library(there)
library(sf)
library(parallel)
library(pbapply)
library(leaflet)
library(colorspace)
library(RColorBrewer)
library(leaflet.providers)
library(leaflet.esri)
```

270m resolution (needs to be small enough that leaflet can handle it)
```{r}
prediction_migration <- raster(here_file("Projects", "Penn_migration_model", "rf_unbiased_6_16_21.tif")) %>% aggregate(9)

prediction_residential <- raster(here_file("Projects", "Penn_residential_model", "rf_random_effects_6_14_21_linktransformed.tif")) %>% 
  projectRaster(crs = crs(prediction_migration)) %>%
  raster::disaggregate(3) %>%
  aggregate(9) %>%
  resample(prediction_migration)

#Set missing values to NA, and then mask to state
prediction_migration[is.na(values(prediction_migration))] <- 0
prediction_residential[is.na(values(prediction_migration))] <- 0

pa_state <- st_read(here_file("Data", "Govt_boundaries", "pennsylvania_5070.shp")) %>%
  st_transform(crs(prediction_migration))

prediction_migration <- mask(prediction_migration, pa_state) %>% projectRaster(crs = "+init=epsg:3857")
prediction_residential <- mask(prediction_residential, pa_state) %>% projectRaster(crs = "+init=epsg:3857")
```

Scaling the prediction rasters to between 0 and 1
```{r}
prediction_migration_scaled <- ((prediction_migration - cellStats(prediction_migration, stat = 'min')) * (1 - 0) / (cellStats(prediction_migration, stat = 'max') - cellStats(prediction_migration, stat = 'min'))) + 0
  
prediction_residential_scaled <- ((prediction_residential - cellStats(prediction_residential, stat = 'min')) * (1 - 0) / (cellStats(prediction_residential, stat = 'max') - cellStats(prediction_residential, stat = 'min'))) + 0
```

Combining with different weights, and rescaling from 0 to 100
```{r}
weight_and_write <- function(weighted_raster, new_name){
  temp_ras <- ((weighted_raster - cellStats(weighted_raster, stat = 'min')) * (100 - 0) / (cellStats(weighted_raster, stat = 'max') - cellStats(weighted_raster, stat = 'min'))) + 0
  writeRaster(temp_ras, filename = new_name, datatype = "INT1U", overwrite = TRUE)
}

weight_and_write(prediction_migration_scaled*100, "m10r0.tif")
weight_and_write((prediction_migration_scaled*90) + (prediction_residential_scaled*10), "m9r1.tif")
weight_and_write((prediction_migration_scaled*80) + (prediction_residential_scaled*20), "m8r2.tif")
weight_and_write((prediction_migration_scaled*70) + (prediction_residential_scaled*30), "m7r3.tif")
weight_and_write((prediction_migration_scaled*60) + (prediction_residential_scaled*40), "m6r4.tif")
weight_and_write((prediction_migration_scaled*50) + (prediction_residential_scaled*50), "m5r5.tif")
weight_and_write((prediction_migration_scaled*40) + (prediction_residential_scaled*60), "m4r6.tif")
weight_and_write((prediction_migration_scaled*30) + (prediction_residential_scaled*70), "m3r7.tif")
weight_and_write((prediction_migration_scaled*20) + (prediction_residential_scaled*80), "m2r8.tif")
weight_and_write((prediction_migration_scaled*10) + (prediction_residential_scaled*90), "m1r9.tif")
weight_and_write(prediction_residential_scaled*100, "m0r10.tif")
```

Loading them (not stored in memory or temp files)
```{r}
m10r0 <- raster("m10r0.tif")
m9r1 <- raster("m9r1.tif")
m8r2 <- raster("m8r2.tif")
m7r3 <- raster("m7r3.tif")
m6r4 <- raster("m6r4.tif")
m5r5 <- raster("m5r5.tif")
m4r6 <- raster("m4r6.tif")
m3r7 <- raster("m3r7.tif")
m2r8 <- raster("m2r8.tif")
m1r9 <- raster("m1r9.tif")
m0r10 <- raster("m0r10.tif")
```


Calculating gameland statistics and appending them as attributes
```{r}
gamelands <- st_read(here_file("Data", "Public_land", "PA_gameland", "PGC_StateGameland2020.shp")) %>%
  st_transform(crs = crs(prediction_migration)) %>% #note: this fixes the acreage bug from launch
  transmute(name = NAME)

numCores <- 10
  cl <- makeCluster(numCores)
  clusterEvalQ(cl, { #preparing each new process to run our code
    library(sf)
    library(raster)
    library(tidyverse)
  })
  clusterExport(cl, "gamelands")
  clusterExport(cl, "m10r0")
  clusterExport(cl, "m9r1")
  clusterExport(cl, "m8r2")
  clusterExport(cl, "m7r3")
  clusterExport(cl, "m6r4")
  clusterExport(cl, "m5r5")
  clusterExport(cl, "m4r6")
  clusterExport(cl, "m3r7")
  clusterExport(cl, "m2r8")
  clusterExport(cl, "m1r9")
  clusterExport(cl, "m0r10")

gamelands$area_ac <- gamelands %>%
  st_transform(crs = 5070) %>%
  st_area(.) %>%
  as.numeric(.)*0.000247105
  
#average habitat in each cell
gamelands$m10r0_mean <- pblapply(1:nrow(gamelands), function(i){
  temp <- raster::extract(x = m10r0, y = as_Spatial(gamelands[i,]))
  mean(temp[[1]], na.rm = TRUE)/100# scale between 0 and 1
}, cl = cl) %>% unlist()

gamelands$m9r1_mean <- pblapply(1:nrow(gamelands), function(i){
  temp <- raster::extract(x = m9r1, y = as_Spatial(gamelands[i,]))
  mean(temp[[1]], na.rm = TRUE)/100
}, cl = cl) %>% unlist()

gamelands$m8r2_mean <- pblapply(1:nrow(gamelands), function(i){
  temp <- raster::extract(x = m8r2, y = as_Spatial(gamelands[i,]))
  mean(temp[[1]], na.rm = TRUE)/100
}, cl = cl) %>% unlist()

gamelands$m7r3_mean <- pblapply(1:nrow(gamelands), function(i){
  temp <- raster::extract(x = m7r3, y = as_Spatial(gamelands[i,]))
  mean(temp[[1]], na.rm = TRUE)/100
}, cl = cl) %>% unlist()

gamelands$m6r4_mean <- pblapply(1:nrow(gamelands), function(i){
  temp <- raster::extract(x = m6r4, y = as_Spatial(gamelands[i,]))
  mean(temp[[1]], na.rm = TRUE)/100
}, cl = cl) %>% unlist()

gamelands$m5r5_mean <- pblapply(1:nrow(gamelands), function(i){
  temp <- raster::extract(x = m5r5, y = as_Spatial(gamelands[i,]))
  mean(temp[[1]], na.rm = TRUE)/100
}, cl = cl) %>% unlist()

gamelands$m4r6_mean <- pblapply(1:nrow(gamelands), function(i){
  temp <- raster::extract(x = m4r6, y = as_Spatial(gamelands[i,]))
  mean(temp[[1]], na.rm = TRUE)/100
}, cl = cl) %>% unlist()


gamelands$m3r7_mean <- pblapply(1:nrow(gamelands), function(i){
  temp <- raster::extract(x = m3r7, y = as_Spatial(gamelands[i,]))
  mean(temp[[1]], na.rm = TRUE)/100
}, cl = cl) %>% unlist()


gamelands$m2r8_mean <- pblapply(1:nrow(gamelands), function(i){
  temp <- raster::extract(x = m2r8, y = as_Spatial(gamelands[i,]))
  mean(temp[[1]], na.rm = TRUE)/100
}, cl = cl) %>% unlist()

gamelands$m1r9_mean <- pblapply(1:nrow(gamelands), function(i){
  temp <- raster::extract(x = m1r9, y = as_Spatial(gamelands[i,]))
  mean(temp[[1]], na.rm = TRUE)/100
}, cl = cl) %>% unlist()

gamelands$m0r10_mean <- pblapply(1:nrow(gamelands), function(i){
  temp <- raster::extract(x = m0r10, y = as_Spatial(gamelands[i,]))
  mean(temp[[1]], na.rm = TRUE)/100
}, cl = cl) %>% unlist()

gamelands$m10r0_si <- gamelands %>%
  mutate(result = m10r0_mean * area_ac) %>% 
  pull(result)

gamelands$m9r1_si <- gamelands %>%
  mutate(result = m9r1_mean * area_ac) %>% 
  pull(result)

gamelands$m8r2_si <- gamelands %>%
  mutate(result = m8r2_mean * area_ac) %>% 
  pull(result)

gamelands$m7r3_si <- gamelands %>%
  mutate(result = m7r3_mean * area_ac) %>% 
  pull(result)

gamelands$m6r4_si <- gamelands %>%
  mutate(result = m6r4_mean * area_ac) %>% 
  pull(result)

gamelands$m5r5_si <- gamelands %>%
  mutate(result = m5r5_mean * area_ac) %>% 
  pull(result)

gamelands$m4r6_si <- gamelands %>%
  mutate(result = m4r6_mean * area_ac) %>% 
  pull(result)

gamelands$m3r7_si <- gamelands %>%
  mutate(result = m3r7_mean * area_ac) %>% 
  pull(result)

gamelands$m2r8_si <- gamelands %>%
  mutate(result = m2r8_mean * area_ac) %>% 
  pull(result)

gamelands$m1r9_si <- gamelands %>%
  mutate(result = m1r9_mean * area_ac) %>% 
  pull(result)

gamelands$m0r10_si <- gamelands %>%
  mutate(result = m0r10_mean * area_ac) %>% 
  pull(result)
```

Calculate the number of cells in the high (67:100) and medium (34:66)
```{r}
gamelands$m10r0_high <- pblapply(1:nrow(gamelands), function(i){
  temp <- raster::extract(x = m10r0, as_Spatial(gamelands[i,])) %>% unlist()
  quantiles <- stats::quantile(getValues(m10r0), 1:100/100, na.rm = TRUE)
  (sum(temp >= quantiles[67]) / length(temp))*100
}, cl = cl) %>% unlist()

gamelands$m9r1_high <- pblapply(1:nrow(gamelands), function(i){
  temp <- raster::extract(x = m9r1, as_Spatial(gamelands[i,])) %>% unlist()
  quantiles <- stats::quantile(getValues(m9r1), 1:100/100, na.rm = TRUE)
  (sum(temp >= quantiles[67]) / length(temp))*100
}, cl = cl) %>% unlist()

gamelands$m8r2_high <- pblapply(1:nrow(gamelands), function(i){
  temp <- raster::extract(x = m8r2, as_Spatial(gamelands[i,])) %>% unlist()
  quantiles <- stats::quantile(getValues(m8r2), 1:100/100, na.rm = TRUE)
  (sum(temp >= quantiles[67]) / length(temp))*100
}, cl = cl) %>% unlist()

gamelands$m7r3_high <- pblapply(1:nrow(gamelands), function(i){
  temp <- raster::extract(x = m7r3, as_Spatial(gamelands[i,])) %>% unlist()
  quantiles <- stats::quantile(getValues(m7r3), 1:100/100, na.rm = TRUE)
  (sum(temp >= quantiles[67]) / length(temp))*100
}, cl = cl) %>% unlist()

gamelands$m6r4_high <- pblapply(1:nrow(gamelands), function(i){
  temp <- raster::extract(x = m6r4, as_Spatial(gamelands[i,])) %>% unlist()
  quantiles <- stats::quantile(getValues(m6r4), 1:100/100, na.rm = TRUE)
  (sum(temp >= quantiles[67]) / length(temp))*100
}, cl = cl) %>% unlist()

gamelands$m5r5_high <- pblapply(1:nrow(gamelands), function(i){
  temp <- raster::extract(x = m5r5, as_Spatial(gamelands[i,])) %>% unlist()
  quantiles <- stats::quantile(getValues(m5r5), 1:100/100, na.rm = TRUE)
  (sum(temp >= quantiles[67]) / length(temp))*100
}, cl = cl) %>% unlist()

gamelands$m4r6_high <- pblapply(1:nrow(gamelands), function(i){
  temp <- raster::extract(x = m4r6, as_Spatial(gamelands[i,])) %>% unlist()
  quantiles <- stats::quantile(getValues(m4r6), 1:100/100, na.rm = TRUE)
  (sum(temp >= quantiles[67]) / length(temp))*100
}, cl = cl) %>% unlist()

gamelands$m3r7_high <- pblapply(1:nrow(gamelands), function(i){
  temp <- raster::extract(x = m3r7, as_Spatial(gamelands[i,])) %>% unlist()
  quantiles <- stats::quantile(getValues(m3r7), 1:100/100, na.rm = TRUE)
  (sum(temp >= quantiles[67]) / length(temp))*100
}, cl = cl) %>% unlist()

gamelands$m2r8_high <- pblapply(1:nrow(gamelands), function(i){
  temp <- raster::extract(x = m2r8, as_Spatial(gamelands[i,])) %>% unlist()
  quantiles <- stats::quantile(getValues(m2r8), 1:100/100, na.rm = TRUE)
  (sum(temp >= quantiles[67]) / length(temp))*100
}, cl = cl) %>% unlist()

gamelands$m1r9_high <- pblapply(1:nrow(gamelands), function(i){
  temp <- raster::extract(x = m1r9, as_Spatial(gamelands[i,])) %>% unlist()
  quantiles <- stats::quantile(getValues(m1r9), 1:100/100, na.rm = TRUE)
  (sum(temp >= quantiles[67]) / length(temp))*100
}, cl = cl) %>% unlist()

gamelands$m0r10_high <- pblapply(1:nrow(gamelands), function(i){
  temp <- raster::extract(x = m0r10, as_Spatial(gamelands[i,])) %>% unlist()
  quantiles <- stats::quantile(getValues(m0r10), 1:100/100, na.rm = TRUE)
  (sum(temp >= quantiles[67]) / length(temp))*100
}, cl = cl) %>% unlist()


gamelands$m10r0_med <- pblapply(1:nrow(gamelands), function(i){
  temp <- raster::extract(x = m10r0, as_Spatial(gamelands[i,])) %>% unlist()
  quantiles <- stats::quantile(getValues(m10r0), 1:100/100, na.rm = TRUE)
  (sum(temp < quantiles[67] & temp >= quantiles[34]) / length(temp))*100
}, cl = cl) %>% unlist()

gamelands$m9r1_med <- pblapply(1:nrow(gamelands), function(i){
  temp <- raster::extract(x = m9r1, as_Spatial(gamelands[i,])) %>% unlist()
  quantiles <- stats::quantile(getValues(m9r1), 1:100/100, na.rm = TRUE)
  (sum(temp < quantiles[67] & temp >= quantiles[34]) / length(temp))*100
}, cl = cl) %>% unlist()

gamelands$m8r2_med <- pblapply(1:nrow(gamelands), function(i){
  temp <- raster::extract(x = m8r2, as_Spatial(gamelands[i,])) %>% unlist()
  quantiles <- stats::quantile(getValues(m8r2), 1:100/100, na.rm = TRUE)
  (sum(temp < quantiles[67] & temp >= quantiles[34]) / length(temp))*100
}, cl = cl) %>% unlist()

gamelands$m7r3_med <- pblapply(1:nrow(gamelands), function(i){
  temp <- raster::extract(x = m7r3, as_Spatial(gamelands[i,])) %>% unlist()
  quantiles <- stats::quantile(getValues(m7r3), 1:100/100, na.rm = TRUE)
  (sum(temp < quantiles[67] & temp >= quantiles[34]) / length(temp))*100
}, cl = cl) %>% unlist()

gamelands$m6r4_med <- pblapply(1:nrow(gamelands), function(i){
  temp <- raster::extract(x = m6r4, as_Spatial(gamelands[i,])) %>% unlist()
  quantiles <- stats::quantile(getValues(m6r4), 1:100/100, na.rm = TRUE)
  (sum(temp < quantiles[67] & temp >= quantiles[34]) / length(temp))*100
}, cl = cl) %>% unlist()

gamelands$m5r5_med <- pblapply(1:nrow(gamelands), function(i){
  temp <- raster::extract(x = m5r5, as_Spatial(gamelands[i,])) %>% unlist()
  quantiles <- stats::quantile(getValues(m5r5), 1:100/100, na.rm = TRUE)
  (sum(temp < quantiles[67] & temp >= quantiles[34]) / length(temp))*100
}, cl = cl) %>% unlist()

gamelands$m4r6_med <- pblapply(1:nrow(gamelands), function(i){
  temp <- raster::extract(x = m4r6, as_Spatial(gamelands[i,])) %>% unlist()
  quantiles <- stats::quantile(getValues(m4r6), 1:100/100, na.rm = TRUE)
  (sum(temp < quantiles[67] & temp >= quantiles[34]) / length(temp))*100
}, cl = cl) %>% unlist()

gamelands$m3r7_med <- pblapply(1:nrow(gamelands), function(i){
  temp <- raster::extract(x = m3r7, as_Spatial(gamelands[i,])) %>% unlist()
  quantiles <- stats::quantile(getValues(m3r7), 1:100/100, na.rm = TRUE)
  (sum(temp < quantiles[67] & temp >= quantiles[34]) / length(temp))*100
}, cl = cl) %>% unlist()

gamelands$m2r8_med <- pblapply(1:nrow(gamelands), function(i){
  temp <- raster::extract(x = m2r8, as_Spatial(gamelands[i,])) %>% unlist()
  quantiles <- stats::quantile(getValues(m2r8), 1:100/100, na.rm = TRUE)
  (sum(temp < quantiles[67] & temp >= quantiles[34]) / length(temp))*100
}, cl = cl) %>% unlist()

gamelands$m1r9_med <- pblapply(1:nrow(gamelands), function(i){
  temp <- raster::extract(x = m1r9, as_Spatial(gamelands[i,])) %>% unlist()
  quantiles <- stats::quantile(getValues(m1r9), 1:100/100, na.rm = TRUE)
  (sum(temp < quantiles[67] & temp >= quantiles[34]) / length(temp))*100
}, cl = cl) %>% unlist()

gamelands$m0r10_med <- pblapply(1:nrow(gamelands), function(i){
  temp <- raster::extract(x = m0r10, as_Spatial(gamelands[i,])) %>% unlist()
  quantiles <- stats::quantile(getValues(m0r10), 1:100/100, na.rm = TRUE)
  (sum(temp < quantiles[67] & temp >= quantiles[34]) / length(temp))*100
}, cl = cl) %>% unlist()
```

```{r}
stopCluster(cl)
```


Saving gamelands to rds and shapefile, and migratory layers to the prerender folder
```{r}
gamelands %>%
  st_transform(4326) %>%
  saveRDS(here_file("Projects", "penn_shiny_app", "woodcock_weighted_habitat", "gamelands.rds"))

gamelands %>%
  st_transform(4326) %>%
  saveRDS(here_file("Projects", "penn_shiny_app", "prerender_PA_app", "gamelands.rds"))

gamelands %>%
  st_transform(4326) %>%
  st_write(here_file("Projects", "penn_shiny_app", "penn_shiny_prep", "gamelands_w_stats.shp"))

writeRaster(m10r0, here_file("Projects", "penn_shiny_app", "prerender_PA_app", "m10r0.tif"))
writeRaster(m9r1, here_file("Projects", "penn_shiny_app", "prerender_PA_app", "m9r1.tif"))
writeRaster(m8r2, here_file("Projects", "penn_shiny_app", "prerender_PA_app", "m8r2.tif"))
writeRaster(m7r3, here_file("Projects", "penn_shiny_app", "prerender_PA_app", "m7r3.tif"))
writeRaster(m6r4, here_file("Projects", "penn_shiny_app", "prerender_PA_app", "m6r4.tif"))
writeRaster(m5r5, here_file("Projects", "penn_shiny_app", "prerender_PA_app", "m5r5.tif"))
writeRaster(m4r6, here_file("Projects", "penn_shiny_app", "prerender_PA_app", "m4r6.tif"))
writeRaster(m3r7, here_file("Projects", "penn_shiny_app", "prerender_PA_app", "m3r7.tif"))
writeRaster(m2r8, here_file("Projects", "penn_shiny_app", "prerender_PA_app", "m2r8.tif"))
writeRaster(m1r9, here_file("Projects", "penn_shiny_app", "prerender_PA_app", "m1r9.tif"))
writeRaster(m0r10, here_file("Projects", "penn_shiny_app", "prerender_PA_app", "m0r10.tif"))
```

