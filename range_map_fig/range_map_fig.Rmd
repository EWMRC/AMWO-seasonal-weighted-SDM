---
title: "R Notebook"
output: html_notebook
---

```{r include = FALSE}
library(tidyverse)
library(sf)
library(here)
library(move)
library(ggpubr)
```

Load range map and merge fall and spring migratory ranges
```{r}
range_shp <- st_read(here("ebird", "amwo_combined_2021_4326.shp")) %>%
  mutate(season = recode(season, 
                         "Spring Migratory Range" = "Migratory Range",
                         "Fall Migratory Range" = "Migratory Range",
                         "Nonbreeding Range" = "Wintering Range")) %>%
  group_by(season) %>%
  summarise(geometry = sf::st_union(geometry)) %>%
  ungroup()
```

Load a basemap
```{r}
basemap_ras <- raster::stack(there::here_file("Data", "basemaps", "esri_lightgrey", "esri_lightgrey_36_48_4326.tif"))
```

Plot the range map using the color scheme from Girl with a Pearl Earring
```{r}
ggplot(range_shp) +
  geom_sf(aes(fill = season), alpha = 0.75) +
  lims(x = c(-100, -60), y = c(25, 55)) +
  labs(fill = NULL) +
  scale_fill_discrete(type = paletteer::paletteer_d("dutchmasters::pearl_earring")) -> range_map_ggplot

range_map_ggplot %>%
  gginnards::append_layers(ggspatial::layer_spatial(data = basemap_ras, lazy = TRUE, dpi = 150), position = "bottom") ->
  range_map_ggplot
range_map_ggplot
```

# Next plot: woodcock migratory movements

Retrieve movement data
```{r}
amwo_sf <- getMovebankData(study = "American Woodcock Migration Ecology in Eastern North America", 
                             login = movebankLogin(username = "LA_Berigan", password = "33szcNUtv4iyPGU"), 
                             removeDuplicatedTimestamps=TRUE) %>% 
  as.data.frame() %>%
  st_as_sf(crs = 4326, coords = c("location_long", "location_lat"), remove = FALSE)
```

Make a line object that shows the tracks for all birds, and then sample down to a reasonable subset
```{r}
amwo_tracks_sf <- amwo_sf %>%
  arrange(timestamp) %>%
  group_by(local_identifier) %>%
  tally() %>% #summarize, but also add an n column
  filter(n > 1) %>% #can't make a line without at least two points
  st_cast("LINESTRING")
```

Plot the lines over the basemap from before
```{r fig.height=15, fig.width=15}
set.seed(8) 
amwo_tracks_sf %>% 
  #sample_n(size = 75) %>%
  ggplot() +
  geom_sf(size = 0.001, alpha = 0.4) +
  lims(x = c(-100, -60), y = c(25, 55)) ->
  migration_map_ggplot

migration_map_ggplot %>%
  gginnards::append_layers(ggspatial::layer_spatial(data = basemap_ras, lazy = TRUE, dpi = 150), position = "bottom") ->
  migration_map_ggplot
migration_map_ggplot
```

Merge into the same plot
```{r fig.height=4.5, fig.width=7.5}
range_migration_combined <- ggarrange(range_map_ggplot, migration_map_ggplot,
               legend = "bottom",
               common.legend = TRUE,
               labels = c("Seasonal ranges", "Migration paths"),
               hjust = -0.35,
               vjust = 2.0,
               font.label = list(size = 12))
range_migration_combined

ggsave("rangemap_multipanel_11_7_2022.tiff", dp = 600, height=4.5, width=7.5)
```

