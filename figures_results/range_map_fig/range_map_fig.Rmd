---
title: "R Notebook"
output: html_notebook
---

```{r include = FALSE}
library(tidyverse)
library(sf)
library(here)
library(move)
library(ggpubr)
library(cowplot)
```

Load range map and merge fall and spring migratory ranges
```{r}
range_shp <- st_read(here("ebird", "amwo_combined_2021_4326.shp")) %>%
  mutate(season = recode(season, 
                         "Spring Migratory Range" = "Migratory Range",
                         "Fall Migratory Range" = "Migratory Range",
                         "Nonbreeding Range" = "Wintering Range")) %>%
  group_by(season) %>%
  summarise(geometry = sf::st_union(geometry)) %>%
  ungroup() %>% 
  filter(season != "Migratory Range") #remove the migratory range from the figure
```

Load hypothesized migratory routes and PA boundary
Paper that the routes are from: Migratory Connectivity of American Woodcock Derived Using Satellite Telemetry
```{r}
routes <- st_read(here("range_map_fig/moore_hypothesized_mig_routes.shp")) %>% 
  dplyr::select(-Id) %>% 
  mutate(linetype = recode(route, 
                           "Eastern" = "31", #dashed
                           "Central" = "solid",
                           "Western" = "11"))#dotted

boundary_pa <- st_read(there::here_file("Data", "Govt_boundaries", "pennsylvania_5070.shp")) %>% 
  st_transform(4326)

bbox_pa <- tibble(geometry = st_as_sfc(st_bbox(boundary_pa))) %>% 
  st_as_sf()
```

Load a basemap
```{r}
basemap_ras <- raster::stack(there::here_file("Data", "basemaps", "esri_lightgrey", "esri_lightgrey_36_48_4326.tif"))
```

Plot the range map using the color scheme from Girl with a Pearl Earring
```{r}
ggplot(range_shp) +
  geom_sf(aes(fill = season), alpha = 0.75) +
  #geom_sf(data = boundary_pa, alpha = 0, lwd = 0.5, color = "black") +
  geom_sf(data = bbox_pa, alpha = 0, lwd = 0.5, color = alpha("#452e32", 0.3)) +
  geom_segment(x = st_bbox(boundary_pa)$xmin, y = st_bbox(boundary_pa)$ymin, xend = -74, yend = 37.2, lwd = 0.5, color = "#452e32", alpha = 0.3) +
  geom_segment(x = st_bbox(boundary_pa)$xmax, y = st_bbox(boundary_pa)$ymin, xend = -59, yend = 37.2, lwd = 0.5, color = "#452e32", alpha = 0.3) +
  geom_sf(data = routes, linetype = "solid", size = 1.5, color = "white") + 
  geom_sf(data = routes, linetype = routes$linetype, size = 1) +
  lims(x = c(-100, -60), y = c(25, 55)) +
  labs(fill = NULL) +
  #scale_fill_discrete(type = paletteer::paletteer_d("dutchmasters::pearl_earring")) 
  scale_fill_manual(values = c("#A65141FF", "#80A0C7FF", "#394165FF")) +
  theme(legend.position = "bottom") ->  
  range_map_ggplot

range_map_ggplot %>%
  gginnards::append_layers(ggspatial::layer_spatial(data = basemap_ras, lazy = TRUE, dpi = 150), position = "bottom") ->
  range_map_ggplot

#range_map_ggplot
```

# Next plot: Pennsylvania zoom-in
```{r}
range_shp_pa <- range_shp %>% 
  st_crop(c(st_bbox(boundary_pa)$ymin-0.25, 
            st_bbox(boundary_pa)$ymax+0.25, 
            st_bbox(boundary_pa)$xmin-0.25, 
            st_bbox(boundary_pa)$xmax+0.25)) #clip to dimensions of the map, otherwise it won't display correctly

pa_map_ggplot <- ggplot(range_shp_pa) +
  geom_sf(aes(fill = season), alpha = 0.75) +
  geom_sf(data = boundary_pa, alpha = 0, lwd = 1, color = "black") + 
  geom_sf(data = routes, linetype = "solid", size = 2, color = "white") + 
  geom_sf(data = routes, linetype = routes$linetype, size = 1) +
  labs(fill = NULL) +
  scale_fill_manual(values = c("#A65141FF", "#80A0C7FF", "#394165FF")) +
  theme(legend.position='none',
        axis.text.x=element_blank(), #remove x axis labels
        axis.ticks.x=element_blank(), #remove x axis ticks
        axis.text.y=element_blank(),  #remove y axis labels
        axis.ticks.y=element_blank(),
        axis.ticks.length = unit(0, "pt"),
        plot.margin=grid::unit(c(0,0,0,0), "mm")) #remove y axis ticks
        

pa_map_ggplot %>%
  gginnards::append_layers(ggspatial::layer_spatial(data = basemap_ras, lazy = TRUE, dpi = 150), position = "bottom") ->
  pa_map_ggplot

pa_map_ggplot <- pa_map_ggplot +
  coord_sf(xlim = c(st_bbox(boundary_pa)$xmin-0.25, st_bbox(boundary_pa)$xmax+0.25),
           ylim = c(st_bbox(boundary_pa)$ymin-0.25, st_bbox(boundary_pa)$ymax+0.25),
           expand = FALSE)

# pa_map_ggplot #needs to render in cairo, otherwise it clips weird
#ggsave(filename = "test1.tiff", type = "cairo")
```



Merge into the same plot
```{r fig.height=4.5, fig.width=7.5}
range_migration_combined <- ggarrange(range_map_ggplot, pa_map_ggplot,
               legend = "bottom",
               common.legend = TRUE,
               labels = c("A", "B"),
               hjust = -0.35,
               vjust = 2.0,
               font.label = list(size = 12))
# range_migration_combined

#ggsave("rangemap_multipanel_11_10_2022.tiff", dp = 600, height=4.5, width=7.5)
```

Make a solid color plot that I can use as a background for the inset map
```{r}
background_plot <- ggplot() +
  theme(panel.background = element_rect(fill = "#452e32"),
        axis.text.x=element_blank(), #remove x axis labels
        axis.ticks.x=element_blank(), #remove x axis ticks
        axis.text.y=element_blank(),  #remove y axis labels
        axis.ticks.y=element_blank(),
        axis.ticks.length = unit(0, "pt"),
        plot.margin=grid::unit(c(0,0,0,0), "mm"))
```

Attempting an inset map using cowplot
```{r}
ggdraw(range_map_ggplot) +
  draw_plot(background_plot,
            # The distance along a (0,1) x-axis to draw the left edge of the plot
            x = 0.645,
            # The distance along a (0,1) y-axis to draw the bottom edge of the plot
            y = 0.28,
            # The width and height of the plot expressed as proportion of the entire ggdraw object
            width = 0.31,
            height = 0.2) +
  draw_plot(pa_map_ggplot,
            # The distance along a (0,1) x-axis to draw the left edge of the plot
            x = 0.65,
            # The distance along a (0,1) y-axis to draw the bottom edge of the plot
            y = 0.23,
            # The width and height of the plot expressed as proportion of the entire ggdraw object
            width = 0.3,
            height = 0.3)

ggsave("figure_inset_12_7_22.tiff", dp = 300, height = 7, width = 7)
```